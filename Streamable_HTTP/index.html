<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Streamable HTTP — MNIST Eğitim</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    #log { width: 100%; height: 220px; white-space: pre-wrap; }
    .row { display: flex; gap: 16px; margin-top: 12px; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
    img { max-width: 360px; border: 1px solid #eee; }
    input { width: 80px; }
  </style>
</head>
<body>
  <h2>MNIST Autoencoder — Streamable HTTP</h2>

  <div>
    Epochs <input id="epochs" type="number" value="5"/>
    Batch <input id="batch" type="number" value="256"/>
    Latent <input id="latent" type="number" value="32"/>
    <button id="startBtn">Eğitimi Başlat</button>
  </div>

  <h3>Log</h3>
  <textarea id="log" readonly></textarea>

  <div class="row">
    <div class="card">
      <h4>Recon Grid</h4>
      <img id="reconImg" alt="recon_grid" />
    </div>
    <div class="card">
      <h4>Error Hist</h4>
      <img id="histImg" alt="error_hist" />
    </div>
  </div>

  <script>
    function append(line) {
      const ta = document.getElementById('log');
      ta.value += line + "\n";
      ta.scrollTop = ta.scrollHeight;
    }

    async function startTraining() {
      const params = {
        epochs: Number(document.getElementById('epochs').value || 5),
        batch_size: Number(document.getElementById('batch').value || 256),
        latent_dim: Number(document.getElementById('latent').value || 32),
      };

      // Streamable HTTP: POST cevabı bir SSE stream
      const res = await fetch("/train", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "text/event-stream"
        },
        body: JSON.stringify(params)
      });

      if (!res.ok || !res.body) {
        append(`[ERR] ${res.status} — stream yok`);
        return;
      }

      const reader = res.body
        .pipeThrough(new TextDecoderStream())
        .getReader();

      let buffer = "";
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += value;

        // basit SSE ayrıştırıcı (event/data satırları)
        const parts = buffer.split("\n\n");
        buffer = parts.pop() || "";
        for (const chunk of parts) {
          const lines = chunk.split("\n");
          let event = "message";
          let data = "";
          for (const ln of lines) {
            if (ln.startsWith("event:")) event = ln.slice(6).trim();
            else if (ln.startsWith("data:")) data += ln.slice(5).trim();
          }
          if (event === "image") {
            try {
              const payload = JSON.parse(data);
              if (payload.name === "recon_grid") {
                document.getElementById('reconImg').src = payload.b64;
              } else if (payload.name === "error_hist") {
                document.getElementById('histImg').src = payload.b64;
              }
              append(`[IMG] ${payload.name} alındı`);
            } catch (e) {
              append(`[IMG] parse hatası: ${e}`);
            }
          } else if (event === "done") {
            append(`[DONE] Eğitim tamamlandı.`);
          } else {
            append(data);
          }
        }
      }
    }

    document.getElementById('startBtn').addEventListener('click', startTraining);
  </script>
</body>
</html>
